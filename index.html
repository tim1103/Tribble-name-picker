<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>随机点名</title>
    <link href="bootstrap.min.css" rel="stylesheet">
    <style>
        @font-face {
            font-family: 'HarmonyOS Sans SC';
            src: url('fonts/HarmonyOS Sans SC Thin.ttf') format('truetype');
            font-weight: 100;
            font-style: normal;
        }

        @font-face {
            font-family: 'HarmonyOS Sans SC';
            src: url('fonts/HarmonyOS Sans SC Light.ttf') format('truetype');
            font-weight: 300;
            font-style: normal;
        }

        @font-face {
            font-family: 'HarmonyOS Sans SC';
            src: url('fonts/HarmonyOS Sans SC Regular.ttf') format('truetype');
            font-weight: 400;
            font-style: normal;
        }

        @font-face {
            font-family: 'HarmonyOS Sans SC';
            src: url('fonts/HarmonyOS Sans SC Medium.ttf') format('truetype');
            font-weight: 500;
            font-style: normal;
        }

        @font-face {
            font-family: 'HarmonyOS Sans SC';
            src: url('fonts/HarmonyOS Sans SC Bold.ttf') format('truetype');
            font-weight: 700;
            font-style: normal;
        }

        @font-face {
            font-family: 'HarmonyOS Sans SC';
            src: url('fonts/HarmonyOS Sans SC Black.ttf') format('truetype');
            font-weight: 900;
            font-style: normal;
        }

        html {
            font-family: 'HarmonyOS Sans', sans-serif;
        }

        body {
            margin: 0;
            font-family: 'HarmonyOS Sans', sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #0d47a1;
            color: white;
            padding: 0 20px;
            height: 60px;
        }

        .navbar h1 {
            margin: 0;
            font-size: 24px;
            font-family: 'HarmonyOS Sans', sans-serif;
        }

        .navbar .class-info {
            font-size: 18px;
        }

        .navbar button {
            width: 120px;
            height: 40px;
            cursor: pointer;
            margin-left: 10px;
        }

        .main-container {
            flex: 1;
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            padding: 10px;
            background-color: #f0f0f0;
        }

        .student-box {
            width: 100px;
            height: 50px;
            background-color: #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-shadow: 1px 1px 1px 1px rgb(196 196 196 / 20%);
            overflow: hidden;
            /* 隐藏溢出的内容 */
        }

        .highlight {
            background-color: #ffc107;
        }

        .bottom-buttons {
            display: flex;
            justify-content: space-around;
            align-items: center;
            background-color: #ffffff;

        }

        .bottom-buttons button {
            border: none;
            cursor: pointer;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            position: relative;
            margin: 5em;
        }

        .modal-content button {
            margin-top: 10px;
        }

        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
            background: none;
            border: none;
            font-size: 20px;
        }



        .names {
            font-size: 2em;
        }

        .number-button {
            width: 2.2em;
            height: 2.2em;
            font-size: 2rem;
            margin: 8px;
            border-radius: 50%;
            --bs-btn-padding-x: 0;
            --bs-btn-padding-y: 0;
        }

        .hidden {
            display: none;
        }

        #dragonCards {
            font-size: 2em;
        }

        /* 设置表格边框 */
        table,
        th,
        td {
            border: 1.5px solid #484848;
        }

        /* 设置表格宽度为100%，并且使边框合并 */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        /* 设置表头和单元格的内边距 */
        th,
        td {
            padding: 12px;
            text-align: center;
            font-size: 1.3em;
        }

        .navbar {
            -webkit-app-region: drag;
            /* 让导航栏可拖动 */
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #0d47a1;
            color: white;
            padding: 0 20px;
            height: 60px;
        }

        /*供electron完成拖动逻辑*/
        .navbar button {
            -webkit-app-region: no-drag;
            /* 按钮不可拖动 */
            cursor: pointer;
            border-radius: 10px;
        }

        .window-controls {
            display: flex;
            gap: 10px;
        }

        .window-controls button {
            background: rgba(0, 0, 0, 0);
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
        }

        .controlbutton {
            border-radius: 5px;
        }

        .window-controls button {
            height: 35px;
            width: 35px;
        }

        #dragonCard {
            margin: 10px 0;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 5px;
            text-align: center;
            opacity: 1;
            font-size: 2em;
            font-weight: bolder;
        }

        /* 新增班级列表样式 */
        .class-list-container {
            max-height: 60vh;
            overflow-y: auto;
            margin: 20px 0;
        }

        .class-item {
            padding: 12px;
            margin: 5px 0;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        /* 网格布局样式 */
        .class-list-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            max-height: 60vh;
            overflow-y: auto;
            padding: 10px;
            width: 80vw;
            /* 控制模态框宽度 */
        }

        .class-item {
            width: 100px;
            height: 50px;
            background-color: #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-shadow: 1px 1px 1px 1px rgb(196 196 196 / 20%);
            cursor: pointer;
            transition: all 0.2s;
            padding: 5px;
            text-align: center;
            word-break: break-all;
            /* 长班级名自动换行 */
        }

        /* 新增动画相关样式 */
        .modal {
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            transform: translateY(-50px);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .modal.show .modal-content {
            transform: translateY(0);
            opacity: 1;
        }


        /* 关闭时反向动画 */
        .modal:not(.show) .modal-content {
            transition: all 0.2s ease-out;
        }

        /* 新增媒体查询 */
        @media (max-width: 960px) {
            .navbar {
                flex-wrap: wrap;
                height: auto;
                padding: 10px;
            }

            .navbar h1 {
                font-size: 1.2rem;
                margin-bottom: 8px;
            }

            .class-info {
                order: 3;
                width: 100%;
                text-align: center;
                font-size: 0.9rem;
                margin-top: 8px;
            }

            .navbar>button {
                width: auto;
                padding: 0 8px;
                font-size: 0.8rem;
                height: 32px;
                margin: 2px;
            }

            .window-controls button {
                width: 28px;
                height: 28px;
            }

            .bottom-buttons {
                flex-wrap: wrap;
                height: auto;
                padding: 8px;
            }

            .bottom-buttons button {
                width: 48%;
                margin: 4px 1%;
                font-size: 0.9rem;
                padding: 8px;
            }
        }

        @media (max-width: 576px) {
            .navbar>button {
                font-size: 0.7rem;
                padding: 0 4px;
            }

            .bottom-buttons button {
                width: 100%;
                margin: 4px 0;
            }

            .main-container {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            }

            .student-box {
                width: 80px;
                height: 40px;
                font-size: 0.8rem;
            }
        }

        /* 修改现有样式 */
        .navbar {
            gap: 8px;
            /* 添加间距 */
            padding: 0 10px;
        }

        .navbar>button {
            min-width: 80px;
            /* 替代固定宽度 */
            width: auto;
            padding: 3px 8px 3px;
            white-space: nowrap;
            /* 防止按钮文字换行 */
        }

        .bottom-buttons {
            gap: 8px;
            padding: 10px;
        }

        .window-controls {
            flex-shrink: 0;
            /* 防止窗口控制按钮被压缩 */
        }

        /* 新增折叠菜单样式 */
        .nav-collapse {
            position: relative;
            display: flex;
            align-items: center;
        }

        .nav-menu-toggle {
            width: 40px;
            height: 40px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            min-width: 160px;
            z-index: 1000;
            display: none;
        }

        .nav-menu.show {
            display: block;
            animation: slideDown 0.3s ease;
        }

        .nav-menu button {
            width: 100%;
            text-align: left;
            padding: 8px 16px;
            border: none;
            background: none;
            border-radius: 0;

        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* 修改原有媒体查询 */
        @media (max-width: 700px) {
            .class-info {
                order: 3;
                width: 100%;
                text-align: center;
                font-size: 0.9rem;
                margin-top: 8px;
            }

            .nav-buttons {
                display: none !important;
            }

            .nav-menu-toggle {
                display: flex !important;
            }
        }

        @media (min-width: 700px) {
            .nav-menu {
                display: none !important;
            }
        }

        /* 新增颜色变量 */
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --accent-color: #4895ef;
            --background: #f8f9fa;
            --text-primary: #2b2d42;
            --text-secondary: #8d99ae;
        }

        /* 整体背景和字体优化 */
        body {
            background: var(--background);
            color: var(--text-primary);

        }

        /* 导航栏现代化改造 */
        .navbar {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);

            padding: 0 2rem;
        }

        .navbar h1 {
            font-weight: 700;
            letter-spacing: -0.5px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* 主内容区卡片样式 */
        .main-container {
            background: transparent;
            padding: 1.5rem;
            gap: 1.2rem;
        }

        .student-box {
            background: white;
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: all 0.2s ease;
            height: 50px;
            font-size: 1rem;
        }

        .highlight {
            background: var(--accent-color) !important;
            color: white;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.02);
            }

            100% {
                transform: scale(1);
            }
        }

        /* 底部按钮组优化 */
        .bottom-buttons {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(8px);
            box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.05);
            padding: 1rem;
            gap: 1rem;
        }

        .bottom-buttons button {
            border-radius: 10px;
            padding: 0.8rem 1.5rem;
            font-weight: 500;
            transition: all 0.2s ease;
            min-width: 140px;
            border: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        }

        /* 模态框现代化 */
        .modal-content {
            border-radius: 15px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            border: none;
            padding: 1.5rem;
        }

        .modal-content h3 {
            color: var(--text-primary);
            margin-bottom: 1.5rem;
        }

        .close-btn {
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }


        /* 表格优化 */
        table {
            border-radius: 12px;
            overflow: hidden;
            background: white;
        }

        th {
            background: var(--primary-color);
            color: white !important;
            font-weight: 600;
        }

        td {
            background: rgba(237, 237, 238, 0.8);
        }

        /* 响应式优化 */
        @media (max-width: 768px) {
            .navbar {
                padding: 0 1rem;
                height: 60px;
            }

            .navbar h1 {
                font-size: 1.4rem;
            }

            .student-box {
                height: 60px;
                font-size: 1rem;
            }

            .bottom-buttons button {
                width: 100%;
                padding: 0.8rem;
                font-size: 0.95rem;
            }
        }

        /* 窗口控制按钮美化 */
        .window-controls button {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        /* 新增数字选择器样式 */
        .number-picker {
            text-align: center;
            padding: 0 20px;
        }

        .rounded-circle {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border: 2px solid #4361ee;
            color: #4361ee;
            transition: all 0.2s;
        }
    </style>
</head>

<body>
    <div class="navbar">
        <div class="d-flex align-items-center gap-3">
            <h1 style="color: white;">🎯 随机点名</h1>
            <div class="class-info text-light opacity-85">
                <span id="className">高一8班</span>
                <span class="mx-2">|</span>
                <span id="studentCount">0人</span>
            </div>
        </div>
        <!-- 新增折叠菜单 -->
        <div class="nav-collapse">
            <!-- 原有按钮组 -->
            <div class="nav-buttons d-none d-md-flex">
                <button onclick="showAboutModal()" class="btn btn-info">关于</button>
                <button onclick="showClassModal()" class="btn btn-info">选择班级</button>
                <button onclick="importList()" class="btn btn-info">导入名单</button>
            </div>

            <!-- 折叠菜单按钮 -->
            <button class="nav-menu-toggle btn btn-info d-md-none toggleNavMenu" onclick="toggleNavMenu()">
                设置
            </button>
        </div>

        <div class="window-controls d-flex align-items-center gap-2">
            <button class="controlbutton" id="minimize-btn"><svg xmlns="http://www.w3.org/2000/svg" width="16"
                    height="16" fill="currentColor" class="bi bi-dash-lg" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M2 8a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11A.5.5 0 0 1 2 8Z" />
                </svg></button> <!-- 最小化按钮 -->
            <button class="controlbutton" id="maximize-btn"><svg xmlns="http://www.w3.org/2000/svg" width="16"
                    height="16" fill="currentColor" class="bi bi-square" viewBox="0 0 16 16">
                    <path
                        d="M14 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z" />
                </svg></button> <!-- 最大化按钮 -->
            <button class="controlbutton" id="close-btn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                    fill="currentColor" class="bi bi-x-lg" viewBox="0 0 16 16">
                    <path
                        d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z" />
                </svg></button> <!-- 关闭按钮 -->
        </div>
    </div>
    <div class="main-container" id="studentContainer"></div>
    <div class="bottom-buttons">
        <button onclick="pickOne()" class="btn btn-lg btn-primary col-12 col-sm-auto">抽取一人</button>
        <button onclick="showNumberSelection()" class="btn btn-lg btn-success col-12 col-sm-auto">抽取多人</button>
        <button onclick="dragonPick()" class="btn btn-lg btn-warning col-12 col-sm-auto">接龙抽选</button>
        <button onclick="randomSeatAssignment()" class="btn btn-lg btn-info col-12 col-sm-auto">随机选座</button>
    </div>
    <!-- 模态框模板 -->
    <div id="seatModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('seatModal')">&times;</span>
            <h3 style="font-weight: bolder;">座位安排</h3>
            <table id="seatTable" border="1" cellpadding="5" cellspacing="0"></table>
            <div style="margin-top: 10px; text-align: center;">
                <button onclick="randomSeatAssignment(true)" class="btn btn-primary">重新分配</button>
            </div>
        </div>
    </div>
    <!-- 模态框模板 -->
    <div id="oneModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('oneModal')">&times;</span>
            <p id="selectedStudent"></p>
            <button onclick="pickOne()" class="btn btn-primary">换一人</button>
        </div>
    </div>
    <div id="multipleModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('multipleModal')">&times;</span>
            <p>请选择抽取人数：</p>
            <div>
                <button onclick="selectNumber(1)" class="btn btn-primary number-button">1</button>
                <button onclick="selectNumber(2)" class="btn btn-primary  number-button">2</button>
                <button onclick="selectNumber(3)" class="btn btn-primary  number-button">3</button>
                <button onclick="selectNumber(4)" class="btn btn-primary  number-button">4</button>
                <button onclick="selectNumber(5)" class="btn btn-primary  number-button">5</button>
                <button onclick="selectNumber(6)" class="btn btn-primary  number-button">6</button>
            </div>
            <p id="selectedStudents"></p>
            <button onclick="pickMultiple()" id="rePickButton" class="btn btn-primary">换一组</button>
        </div>
    </div>
    <div id="dragonModal" class="modal">
        <div class="modal-content roster-modal">
            <span class="close-btn" onclick="closeModal('dragonModal')">&times;</span>
            <div id="dragonCard" class="card">请点击“下一位”开始抽选</div>
            <button onclick="nextDragonPick()" class="btn btn-primary">下一位</button>
        </div>
    </div>
    <!-- 新增班级选择模态框 -->
    <div id="classModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('classModal')">&times;</span>
            <h3 style="font-weight: bolder;">请选择班级</h3>
            <div id="classList" class="class-list-container"></div>
        </div>
    </div>
    <div id="seatSettingModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('seatSettingModal')">&times;</span>
            <h3 style="font-weight: bolder;">座位设置</h3>
            <div class="d-flex justify-content-around my-4">
                <!-- 列数选择器 -->
                <div class="number-picker">
                    <div class="text-center mb-2">列数</div>
                    <div class="d-flex align-items-center">
                        <button class="btn btn-primary rounded-circle px-3 py-1" onclick="adjustColumn(-1)">-</button>
                        <span id="columnValue" class="mx-3 fs-4">8</span>
                        <button class="btn btn-primary rounded-circle px-3 py-1" onclick="adjustColumn(1)">+</button>
                    </div>
                </div>
                <!-- 行数选择器 -->
                <div class="number-picker">
                    <div class="text-center mb-2">行数</div>
                    <div class="d-flex align-items-center">
                        <button class="btn btn-primary rounded-circle px-3 py-1" onclick="adjustRow(-1)">-</button>
                        <span id="rowValue" class="mx-3 fs-4">1</span>
                        <button class="btn btn-primary rounded-circle px-3 py-1" onclick="adjustRow(1)">+</button>
                    </div>
                </div>
            </div>
            <div class="text-center mt-3">
                <button onclick="generateSeat()" class="btn btn-primary">确定</button>
            </div>
        </div>
    </div>
    <script src="sheet.js"></script>
    <script>
        let students = [];
        let selectedNumber = 0;
        let selectedStudents = [];

        function importList() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.txt';
            input.onchange = function (e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (event) {
                        const lines = event.target.result.split('\n').filter(line => line.trim());
                        if (lines.length === 0) {
                            Swal.fire({
                                icon: "error",
                                title: "文件格式错误",
                                confirmButtonColor: "#3085d6",
                                text: "导入的名单文件为空或格式不正确，请检查后重新上传！"
                            });
                            return;
                        }
                        students = lines;
                        const className = file.name.split('.').slice(0, -1).join('.');
                        document.getElementById('className').innerText = className;
                        updateStudentCount();
                        renderStudents();
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        function updateStudentCount() {
            document.getElementById('studentCount').innerText = `${students.length}人`;
        }

        function renderStudents() {
            const container = document.getElementById('studentContainer');
            container.innerHTML = '';
            students.forEach(student => {
                const div = document.createElement('div');
                div.className = 'student-box';
                div.innerText = student;
                container.appendChild(div);
            });
        }

        function highlightStudents(indices, clearAll) {
            const boxes = document.querySelectorAll('.student-box');
            boxes.forEach((box, index) => {
                box.classList.remove('highlight');
                if (!clearAll && indices.includes(index)) {
                    box.classList.add('highlight');
                }
            });
        }

        // 隐藏选择人数的UI元素的方法
        function hideNumberSelectionUI() {
            document.querySelector('#multipleModal p:first-of-type').classList.add('hidden'); // 隐藏提示文案
            document.querySelectorAll('.number-button').forEach(button => button.classList.add('hidden')); // 隐藏按钮
        }

        // 显示选择人数的UI元素的方法
        function showNumberSelectionUI() {
            document.querySelector('#multipleModal p:first-of-type').classList.remove('hidden'); // 显示提示文案
            document.querySelectorAll('.number-button').forEach(button => button.classList.remove('hidden')); // 显示按钮
        }

        function pickMultiple() {
            if (students.length < selectedNumber) {
                Swal.fire({
                    icon: "error",
                    title: "人数过少",
                    confirmButtonColor: "#3085d6",
                    text: `当前班级人数少于选择的抽取人数，请减少抽取人数！`
                });
                return;
            }
            if (selectedNumber > 0) {
                let selectedIndices = new Set(); // 使用Set来保证唯一性

                while (selectedIndices.size < selectedNumber) {
                    const randomIndex = Math.floor(Math.random() * students.length);
                    selectedIndices.add(randomIndex); // 自动忽略已经存在的索引
                }

                // 将Set转换为Array并获取对应的学生名字
                const selectedNames = Array.from(selectedIndices).map(i => students[i]).join(' ');
                //document.getElementById('selectedStudents').innerHTML = `被选中的同学是：<br><strong class="names">${selectedNames}</strong>`;
                const container = document.getElementById('selectedStudents');
                container.innerHTML = '被选中的同学是：<br><strong class="names"></strong>';  // 静态HTML
                container.querySelector('.names').textContent = selectedNames;  // 安全插入内容

                document.getElementById('rePickButton').style.display = 'block';
                hideNumberSelectionUI();
            }
        }

        function selectNumber(number) {
            selectedNumber = number;
            pickMultiple();
        }

        let currentStudentIndex = -1; // 当前显示的学生索引
        // 全局定义 handleKeyDown 函数
        let handleKeyDown;


        function removeKeyboardListeners() {
            // 移除键盘事件监听器
            if (handleKeyDown) {
                document.removeEventListener('keydown', handleKeyDown);
            }
        }

        // 修改后的showModal函数
        function showModal(modalId, message) {
            const modal = document.getElementById(modalId);
            modal.classList.add('show');
            if (message) {
                document.querySelector(`#${modalId} p`).innerHTML = message;
            }
            addKeyboardListeners(modalId);
        }

        // 修改后的closeModal函数
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.remove('show');
            removeKeyboardListeners();

            // 清除接龙状态
            if (modalId === 'dragonModal') {
                setTimeout(function () {
                    document.getElementById('dragonCard').innerText = "请点击“下一位”开始抽选";
                }, 300);
            }
        }

        function pickOne() {
            closeModal('oneModal');
            highlightStudents([], true);
            const randomIndex = Math.floor(Math.random() * students.length);
            highlightStudents([randomIndex], false);
            //showModal('oneModal', `被选中的同学是：<br><strong class="names">${students[randomIndex]}</strong>`);
            const modal = document.getElementById('oneModal');
            modal.querySelector('p').innerHTML = '被选中的同学是：<br><strong class="names"></strong>';
            modal.querySelector('.names').textContent = students[randomIndex];
            showModal('oneModal');
        }
        function showNumberSelection() {
            selectedNumber = 0;
            document.getElementById('selectedStudents').innerText = '';
            document.getElementById('rePickButton').style.display = 'none';

            // 确保显示选择人数的UI元素
            showNumberSelectionUI();
            showModal('multipleModal');
        }

        /*function randomSeatAssignment(refresh) {
            if (students.length > 200) {
                Swal.fire({
                    icon: "error",
                    title: "人数过多",
                    confirmButtonColor: "#3085d6",
                    text: "请确认人数少于200人后再使用随机选座功能！"
                });
                return;
            } else {
                const seatTable = document.getElementById('seatTable');
                const columns = 8;
                let rowsNeeded = Math.ceil(students.length / columns);

                if (refresh || !seatTable.innerHTML.trim()) {
                    seatTable.innerHTML = '';

                    for (let row = 0; row < rowsNeeded; row++) {
                        let tableRow = '<tr>';
                        for (let col = 0; col < columns; col++) {
                            tableRow += `<td></td>`;
                        }
                        tableRow += '</tr>';
                        seatTable.innerHTML += tableRow;
                    }

                    // 修改后的洗牌逻辑
                    let shuffledStudents = shuffleArray([...students]);

                    let index = 0;
                    const cells = seatTable.getElementsByTagName('td');
                    for (let i = 0; i < cells.length && index < students.length; i++) {
                        if (cells[i]) {
                            cells[i].innerText = shuffledStudents[index++];
                        }
                    }
                }

                if (!refresh) {
                    showModal('seatModal');
                }
            }
        }*/

        // 使用更科学的 Fisher-Yates 洗牌算法
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // 修改洗牌部分

        let currentShuffledStudents = []; // 存储当前轮次随机排序的数组
        let currentIndex = 0;             // 当前抽取位置索引

        function nextDragonPick() {
            // 当需要开始新轮次时自动重置
            if (currentIndex >= currentShuffledStudents.length) {
                console.log("已开始新一轮抽选");
                currentShuffledStudents = shuffleArray([...students]);
                console.log(currentShuffledStudents);
                currentIndex = 0;
            }

            const currentStudent = currentShuffledStudents[currentIndex];
            currentIndex++;
            document.getElementById('dragonCard').innerText = currentStudent;
        }

        // 修改键盘事件监听逻辑
        function addKeyboardListeners(modalId) {
            removeKeyboardListeners(); // 先移除旧的
            handleKeyDown = function (event) {
                if (event.key === 'Enter' || event.key === 'ArrowDown' || event.key === 'PageDown') {
                    switch (modalId) {
                        case 'oneModal':
                            pickOne();
                            break;
                        case 'multipleModal':
                            pickMultiple();
                            break;
                        case 'seatModal':
                            randomSeatAssignment(true);
                            break;
                        case 'dragonModal':
                            nextDragonPick(); // 直接调用正常抽选逻辑
                            break;
                    }
                }
            };
            document.addEventListener('keydown', handleKeyDown);
        }

        // 确保接龙入口函数正确初始化
        function dragonPick() {
            currentShuffledStudents = shuffleArray([...students]);
            currentIndex = 0;
            nextDragonPick();
            showModal('dragonModal');
        }

        // 移除原来的populateDropdown函数，改为新的填充函数
        function populateClassModal() {
            const container = document.getElementById('classList');
            container.innerHTML = '';

            for (const className in predefinedClasses) {
                const div = document.createElement('div');
                div.className = 'class-item';
                div.innerText = className;
                div.onclick = () => {
                    changeClass(className);
                    closeModal('classModal');
                };
                container.appendChild(div);
            }
        }

        // 新增显示班级模态框函数
        function showClassModal() {
            populateClassModal();
            showModal('classModal');
        }
        function changeClass(className) {
            if (predefinedClasses.hasOwnProperty(className)) {
                students = predefinedClasses[className];
                document.getElementById('className').innerText = className;
                updateStudentCount();
                renderStudents();
                // 添加成功提示

                const Toast = Swal.mixin({
                    toast: true,
                    position: "top",
                    showConfirmButton: false,
                    timer: 2000,
                    timerProgressBar: true,
                    didOpen: (toast) => {
                        toast.onmouseenter = Swal.stopTimer;
                        toast.onmouseleave = Swal.resumeTimer;
                    }
                });
                Toast.fire({
                    icon: "success",
                    title: "班级切换成功"
                });
            } else {
                Swal.fire({
                    icon: "error",
                    title: "系统内部错误",
                    text: "班级不存在,请检查班级数据或联系管理员"
                });
            }
        }


        document.addEventListener('DOMContentLoaded', async () => {
            // 加载配置文件
            const config = await window.electronAPI.loadConfig();
            let hasValidConfig = false;

            if (config && config.className && predefinedClasses[config.className]) {
                students = predefinedClasses[config.className];
                document.getElementById('className').innerText = config.className;
                hasValidConfig = true;
            } else {
                // 如果没有有效配置，使用第一个预定义班级作为临时默认值
                const defaultClass = Object.keys(predefinedClasses)[0] || '高一8班';
                students = predefinedClasses[defaultClass] || [];
                document.getElementById('className').innerText = defaultClass;
            }

            updateStudentCount();
            renderStudents();

            // 如果配置无效，显示班级选择模态框
            if (!hasValidConfig) {
                // 延迟确保DOM渲染完成
                setTimeout(() => {
                    showClassModal();
                    Swal.fire({
                        icon: "info",
                        title: "请选择班级",
                        text: "检测到您是首次使用或配置丢失，请先选择班级（注：如您希望直接导入名单，可直接关闭选择班级的对话框）",
                        confirmButtonColor: "#3085d6"
                    });
                }, 100);
            }
        });
        async function changeClass(className) {
            if (predefinedClasses.hasOwnProperty(className)) {
                students = predefinedClasses[className];
                document.getElementById('className').innerText = className;
                updateStudentCount();
                renderStudents();
                // 保存配置
                const success = await window.electronAPI.saveConfig(className);

                const Toast = Swal.mixin({
                    toast: true,
                    position: "top",
                    showConfirmButton: false,
                    timer: 2000,
                    timerProgressBar: true,
                    didOpen: (toast) => {
                        toast.onmouseenter = Swal.stopTimer;
                        toast.onmouseleave = Swal.resumeTimer;
                    }
                });
                Toast.fire({
                    icon: "success",
                    title: "班级切换成功"
                });
                // 保存配置
                const result = await window.electronAPI.saveConfig(className);
                if (!result.success) {
                    Swal.fire({
                        icon: "error",
                        title: "保存失败",
                        text: `无法保存配置: ${result.error || '未知错误'}`
                    });
                    return;
                }

                // 显示保存成功提示
                Toast = Swal.mixin({
                    toast: true,
                    position: "top",
                    showConfirmButton: false,
                    timer: 2000,
                    timerProgressBar: true,
                    didOpen: (toast) => {
                        toast.onmouseenter = Swal.stopTimer;
                        toast.onmouseleave = Swal.resumeTimer;
                    }
                });

                Toast.fire({
                    icon: "success",
                    title: result.isElevated ?
                        "已通过管理员权限保存配置" :
                        "配置保存成功"
                });
            } else {
                Swal.fire({
                    icon: "error",
                    title: "系统内部错误",
                    text: "班级不存在,请检查班级数据或联系管理员"
                });
            }

        }

        // 新增菜单切换功能
        function toggleNavMenu() {
            const menu = document.querySelector('.nav-menu');
            menu.classList.toggle('show');

            // 点击外部关闭菜单
            if (menu.classList.contains('show')) {
                document.addEventListener('click', closeMenuOnClickOutside);
            } else {
                document.removeEventListener('click', closeMenuOnClickOutside);
            }
        }

        function closeMenuOnClickOutside(event) {
            const menu = document.querySelector('.nav-menu');
            const toggleButton = document.querySelector('.nav-menu-toggle');

            if (!menu.contains(event.target) && !toggleButton.contains(event.target)) {
                menu.classList.remove('show');
                document.removeEventListener('click', closeMenuOnClickOutside);
            }
        }

        // 新增座位设置相关变量
        let currentColumns = 8;
        let currentRows = 1;

        // 修改后的randomSeatAssignment函数
        function randomSeatAssignment() {
            if (students.length === 0) {
                Swal.fire("请先导入或选择班级名单");
                return;
            }
            // 计算初始行列
            const minColumns = Math.ceil(students.length / 50); // 每行最多50人
            currentColumns = Math.max(8, minColumns);
            currentRows = Math.ceil(students.length / currentColumns);

            document.getElementById('columnValue').textContent = currentColumns;
            document.getElementById('rowValue').textContent = currentRows;
            showModal('seatSettingModal');
        }

        // 调整列数
        function adjustColumn(delta) {
            currentColumns = Math.max(1, currentColumns + delta);
            currentRows = Math.ceil(students.length / currentColumns);
            updateUIValues();
        }

        // 调整行数
        function adjustRow(delta) {
            currentRows = Math.max(1, currentRows + delta);
            currentColumns = Math.ceil(students.length / currentRows);
            updateUIValues();
        }

        // 更新界面数值
        function updateUIValues() {
            document.getElementById('columnValue').textContent = currentColumns;
            document.getElementById('rowValue').textContent = currentRows;
        }

        // 生成座位表
        function generateSeat() {
            closeModal('seatSettingModal');
            const totalSeats = currentColumns * currentRows;
            if (totalSeats < students.length) {
                Swal.fire({
                    icon: "error",
                    title: "座位数不足",
                    confirmButtonColor: "#3085d6",
                    text: `请增加行或列后重试`
                });
                return;
            }
            const seatTable = document.getElementById('seatTable');
            seatTable.innerHTML = '';

            // 创建表格
            for (let i = 0; i < currentRows; i++) {
                const row = document.createElement('tr');
                for (let j = 0; j < currentColumns; j++) {
                    row.appendChild(document.createElement('td'));
                }
                seatTable.appendChild(row);
            }

            // 填充数据
            const shuffled = shuffleArray([...students]);
            const cells = seatTable.getElementsByTagName('td');
            for (let i = 0; i < cells.length; i++) {
                cells[i].textContent = i < shuffled.length ? shuffled[i] : '';
            }

            showModal('seatModal');
        }


        // 在DOM加载时插入菜单
        document.addEventListener('DOMContentLoaded', () => {
            const navCollapse = document.querySelector('.nav-collapse');
            const menu = document.createElement('div');
            menu.className = 'nav-menu';
            menu.innerHTML = `
        <button onclick="showAboutModal()">关于</button>
        <button onclick="showClassModal()">选择班级</button>
        <button onclick="importList()">导入名单</button>
    `;
            navCollapse.appendChild(menu);
        });
        //禁止选中文本
        document.onselectstart = function () { return false }

        //Electron应用关闭处理
        document.getElementById('minimize-btn').addEventListener('click', () => {
            window.electron.send('window-minimize');
        });

        document.getElementById('maximize-btn').addEventListener('click', () => {
            window.electron.send('window-maximize');
        });

        document.getElementById('close-btn').addEventListener('click', () => {
            window.electron.send('window-close');
        });

        //关于模态框
        function showAboutModal() {
            window.location.href = "about.html";
            //showModal('aboutModal');
        }
    </script>
    <script src="bootstrap.bundle.min.js"></script>
    <script src="sweetalert2@11.js"></script>
</body>

</html>